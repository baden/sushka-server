# Сервер для приборов сушки.

## Структура

Сервер создает три порта для работы:

1. (Data) Порт обмена с прибором. Получает данные с приборов и отправляет в ответ команды управления или параметры.
2. (Socket) Порт двухстороннего обмена с WEB-интерфейсом.
3. (Web) Порт WEB-интерфейса (не обязательный)

```
┌──────────┐        ┌──────────┐
│          ├───────►│          │
│  Прибор  │        │   Data   │
│          │◄───────┤          │
└──────────┘        └──────────┘

                    ┌──────────┐
                    │          │
                ┌──►│  Socket  │
┌───────────┐   │   │          │
│           │◄──┘   └──────────┘
│  Оператор │
│           │◄─┐    ┌──────────┐
└───────────┘  │    │          │
               └────┤   Web    │
                    │          │
                    └──────────┘
```

## Токен

Раздел в разработке.
На данный момент используйте значение токена равное `default-token`.

## Протокол порта обмена (Data).

Передача данных с приборов осуществляется посредством HTTP POST-запроса.
Данне передаются в виде текстовых строк. Одна строка - один параметр. Строки имеют вид:
```
<поле>=<значение>
```

Пример запроса:
```
POST /default-token/1234

time=Заморозка: 26:15
t1=56
t2=58
vacuum1=940
wifi=50
```

В ответ придет набор строк с командами управления (если есть) или измененными параметрами. Формат ответа аналогичен формату запроса -
набор строк вида `<поле>=<значение>`

Образец:
```
key1=1
tsub=40
```

Для корректрой работы необходимо установить заголовок

```
Content-Type: text/plain
```

Пример реализации отправки на Arduino (работоспособность не проверялась):

```cpp

#include <HTTPClient.h>

...
...
...

const char* TOKEN = "default-token";
const char* HWID = "1234";

String test_send() {
    HTTPClient http;

    http.begin("http://sushka.navi.cc:8081/" + TOKEN + "/" + HWID);

    String payload = "t1=50\nt2=60\n";
    int httpResponseCode = http.POST(payload);

    String response = "";
    if (httpResponseCode == 200) {
        response = http.getString();
    } else {
        Serial.print("Error code: ");
        Serial.println(httpResponseCode);        
    }
    http.end();
    return response;
}
```


## Типы и значения полей

Имя параметра должно стостоять из латинских букв. Регистр имеет значение.

### Специяльные поля

Поля, начинающиеся с символа `$` являются управляющими и не должны использоваться в элементах интерфейса.
Список управляющих полей:

- $page - Имя страницы интерфейса (см раздел ["Интерфейс"](Интерфейс))
- $start - Начать серию (смотри описание ниже).
- $stop - Завершить серию (смотри описание ниже).

### События

Поля, начинающиеся с символа `#` будут сохранены в базу данных для
возможности последующего просмотра всей истории передачи.
Такие поля могут использованы, например, для передачи сообщений об ощибках или логов работы.
Пример использования:

```
#errorMsg=Ошибка заморозки. Превышено время ожидания.
```

Данное событие будет сохранено в базе данных и на специальной странице можно будет посмотреть когда было передано данное сообщение. Также это поле
можно использовать в интерфейсе как обычное поле `errorMsg` для отображения его последнего переданного значения.

### Серии

Поля, начинающиеся с символа '!' будут сохранены в базе данных для последующего просмотра. Но в отличие от полей с символом `#` данные поля используются для сохранения серии данных и могут содержать __только целые числовые значения__. Данные поля сохраняются в виде пакета данных и должны передаваться в помощью специальной последовательности:

1. Передается управляющая команда для начала серии.
2. Передаются необходимые параметры с префиксом "!". Пункт 2 повтояется нужное кол-во раз.
3. Передается управляющая команда для конца серии.

```
$start=Сублимация
```

Будет создана серия с именем "Сублимация" и меткой текущего времени.

Передаем серию нужное кол-во раз:

```
!t1=10
!t2=40
```
Повторяем несколько раз, передавая нужные данные.

```
$stop=Сублимация
```
Серия с именем "Сублимация" будет закрыта и будет доступна на специальной
странице для будущего просмотра в виде графика.

Также эти поля
можно использовать в интерфейсе как обычные поля `t1` и `t2` для отображения его последнего переданного значения.

При желании, определенное значение можно пометить на графике. Для этого нужно дополнительно со значением передать
специальную строку вида `параметр:Аннотация`.

Например:

```
!t1=10
!ann1=t1:Превышение температуры
```

Нужно позаботиться о том, чтобы данные аннотации слались один раз в нужном месте, так как они все будут отображены на графике
и могут накладываться друг на друга.

Если нужно добавить подпись для нескольких параметров, то нужно дать уникальное имя каждой аннотации:
```
!t1=10
!t2=50
!ann1=t1:Превышение температуры
!ann2=t2:Отключение
```


## Интерфейс

Можно создавать страницы интерфейса, перейдя по [ссылке /editor](http://sushka.navi.cc/editor).

## WEB страница

На данный момент, задать идентификатор прибора можно указав его в адресной строке после символа `#`:

https://sushka.navi.cc/#1234

Если нужно изменить идентификатор, то его нужно указать в адресной строке, а затем перезагрузить страницу в браузере (F5).


## Запуск сервера

```
npm i
npm run build
node ./server.js
```

Можно открыть страницу по адресу `http://localhost:8080/#1234`.

## Запуск WEB-сервера для отладки

```
npm i
npm run notserve
```

Можно открыть страницу по адресу `http://localhost:9000/#1234`.

При изменении исходных файлов, WEB-страница будет перекомпилирована. Некоторые элементы будут обновлены автоматически, например, файл стилей. Для обновления остального, достаточно обновить страницу в браузере.


## Использование внешнего хостинга для WEB.

WEB-страница не является частью сервера, и может использоваться отдельно.
Ее можно разместить на собственном хостинге.

Для этого нужно собрать WEB-страницу:

```
npm i
npm run build
```

И содержимое каталога `./dist` можно скопировать на произвольный хостинг.
В настройках хостинга, нужно настроить переадресацию ошибки `404` на страницу `index.html`.
